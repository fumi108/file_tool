# ================================
# ■ 引数として入力ファイルを受け取る
# ================================
param (
    [string]$inputFile
)

# ================================
# ■ 引数が指定されていない場合のチェック
# ================================
if (-not $inputFile) {
    Write-Host "⚠ 入力ファイルを指定してください！"
    pause
    exit
}

# ================================
# ■ ファイルの存在チェック
# ================================
if (-not (Test-Path $inputFile)) {
    Write-Host "❌ 指定されたファイルが存在しません: $inputFile"
    pause
    exit
}

# ================================
# ■ 設定値
# ================================
$chunkSize  = 1GB   # 分割サイズ（1ファイルあたり）
$bufferSize = 4MB   # 一度に読み込むバッファサイズ

# ================================
# ■ 入力ファイルを読み込みモードでオープン
# ================================
$fs = [IO.File]::OpenRead($inputFile)

# ■ 入力ファイル全体のサイズ取得（進捗計算用）
$totalSize = $fs.Length

# ================================
# ■ 処理開始ログ
# ================================
Write-Host "📂 入力ファイル: $inputFile"
Write-Host "📦 分割サイズ: 1GB"
Write-Host "▶ 分割処理スタート！"
Write-Host "--------------------------------------"

# ================================
# ■ バッファ配列の作成
# ================================
$buffer = New-Object byte[] $bufferSize

# ■ 分割ファイルの通し番号
$part = 1

# ■ 全体でどこまで処理したかの累積値
$processedTotal = 0

# ================================
# ■ ファイルの終端までループ
# ================================
while ($fs.Position -lt $fs.Length) {

    # ■ 出力ファイル名の作成
    $outputFile = "$inputFile.part$part"

    # ■ 出力ファイルを新規作成
    $ofs = [IO.File]::OpenWrite($outputFile)

    # ■ 今回の分割ファイルに書き込んだサイズ
    $written = 0

    Write-Host "🛠  作成中: $outputFile"

    # ================================
    # ■ 1GB または ファイル終端まで書き込み
    # ================================
    while ($written -lt $chunkSize -and $fs.Position -lt $fs.Length) {

        # ■ 元ファイルからデータを読み込み
        $read = $fs.Read($buffer, 0, $bufferSize)

        # ■ 読み込んだデータを分割ファイルに書き込み
        $ofs.Write($buffer, 0, $read)

        # ■ 現在の分割ファイルの書込量を更新
        $written += $read

        # ■ 全体の処理済みサイズを更新
        $processedTotal += $read

        # ================================
        # ■ 進捗率を計算（％）
        # ================================
        $percent = [int](($processedTotal / $totalSize) * 100)

        # ================================
        # ■ 進捗バーを表示
        # ================================
        Write-Progress `
            -Activity "ファイル分割中" `
            -Status "$percent% 完了" `
            -PercentComplete $percent
    }

    # ================================
    # ■ 分割ファイルをクローズ
    # ================================
    $ofs.Close()

    # ================================
    # ■ 作成された分割ファイルのサイズ表示
    # ================================
    $sizeMB = [Math]::Round((Get-Item $outputFile).Length / 1MB, 2)
    Write-Host "✅ 完了: $outputFile (${sizeMB}MB)"

    # ■ 次の分割ファイル番号へ
    $part++
}

# ================================
# ■ 元ファイルをクローズ
# ================================
$fs.Close()

# ================================
# ■ 進捗バーを消す
# ================================
Write-Progress -Activity "ファイル分割中" -Completed

# ================================
# ■ 完了ログ
# ================================
Write-Host "--------------------------------------"
Write-Host "🎉 すべての分割が完了しました！"
pause
